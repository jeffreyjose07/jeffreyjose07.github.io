name: Build and Deploy Blog

on:
  push:
    branches: [ main ]
    paths:
      - 'blog/posts/**'
      - 'blog/templates/**'
      - 'blog/scripts/**'
      - 'blog/config.json'
      - '.github/workflows/blog-build.yml'
  workflow_dispatch: # Allow manual triggering

jobs:
  build-blog:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # Fetch full history so we can detect which posts changed
        fetch-depth: 0
        # Use a personal access token that can push to the repo
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check for blog changes
      id: changes
      run: |
        # Check if there are any blog-related changes
        if git diff --name-only HEAD~1 HEAD | grep -E '^blog/(posts|templates|scripts|config\.json)' > /dev/null; then
          echo "blog_changed=true" >> $GITHUB_OUTPUT
          echo "📝 Blog content changes detected"
        else
          echo "blog_changed=false" >> $GITHUB_OUTPUT
          echo "📝 No blog content changes detected"
        fi
    
    - name: Build blog
      if: steps.changes.outputs.blog_changed == 'true'
      run: |
        echo "🚀 Building blog..."
        npm run build:blog
        echo "✅ Blog build completed"
    
    - name: Check for generated files
      if: steps.changes.outputs.blog_changed == 'true'
      id: generated
      run: |
        if [ -n "$(git status --porcelain public/blog/)" ]; then
          echo "files_generated=true" >> $GITHUB_OUTPUT
          echo "📄 Generated files detected:"
          git status --porcelain public/blog/
        else
          echo "files_generated=false" >> $GITHUB_OUTPUT
          echo "📄 No new files generated"
        fi
    
    - name: Commit and push generated files
      if: steps.changes.outputs.blog_changed == 'true' && steps.generated.outputs.files_generated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add generated blog files
        git add public/blog/
        
        # Create commit message based on changes
        CHANGED_POSTS=$(git diff --name-only HEAD~1 HEAD | grep 'blog/posts/' | sed 's|blog/posts/||g' | sed 's|\.md$||g' | tr '\n' ',' | sed 's/,$//')
        
        if [ -n "$CHANGED_POSTS" ]; then
          git commit -m "auto: rebuild blog posts ($CHANGED_POSTS)
          
          Generated HTML files from Markdown source.
          - Updated blog index
          - Applied terminal color scheme
          - Responsive typography maintained"
        else
          git commit -m "auto: rebuild blog
          
          Generated HTML files from updated templates or configuration."
        fi
        
        # Push changes
        git push
        echo "✅ Blog files committed and pushed"
    
    - name: Summary
      if: steps.changes.outputs.blog_changed == 'true'
      run: |
        echo "🎉 Blog build workflow completed successfully!"
        if [ "${{ steps.generated.outputs.files_generated }}" == "true" ]; then
          echo "📝 New blog files have been generated and committed"
          echo "🌐 Changes will be live on GitHub Pages within a few minutes"
        else
          echo "📝 No new files needed to be generated"
        fi